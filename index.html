<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç§˜è¡“å¡”ç¾… (æœ€çµ‚ä¿®å¾©ç‰ˆ)</title>
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <!-- å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Abhaya+Libre&family=Stalemate&family=Cinzel:wght@400;700&family=Noto+Serif+TC:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #1a1510;
            --btn-bg: #c89775;
            --accent-gold: #d4af37;
            --accent-cream: #f3e5ab;
            --text-main: #e0d8c3;
            --card-w: 160px;
            --card-h: 280px;
        }

        body {
            margin: 0; padding: 0;
            background-color: black;
            color: white;
            font-family: 'Noto Serif TC', serif;
            overflow: hidden;
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column;
            user-select: none;
        }

        /* --- é€šç”¨ UI --- */
        .screen {
            position: absolute; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.8s ease-in-out;
            z-index: 10;
        }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 20; }

        /* =========================================
           1. é¦–é  (Figma é‚„åŸ + START æŒ‰éˆ•ä¿®å¾©)
           ========================================= */
        #screen-home { background: black; overflow: hidden; }
        #life-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; cursor: crosshair; }
        
        .home-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none;
        }

        .title-main {
            position: absolute; font-family: 'Abhaya Libre', serif; font-size: 80px; color: white;
            width: 100%; text-align: center; top: 20%; left: 0;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .title-sub {
            position: absolute; font-family: 'Stalemate', cursive; font-size: 90px;
            width: 100%; text-align: center; top: 30%; left: 0;
            background: linear-gradient(to right, #008080, #fe9d72);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        /* [ä¿®å¾©] START æŒ‰éˆ•ç½®ä¸­èˆ‡å®šä½ */
        .btn-start-figma {
            position: absolute; width: 287px; height: 98px;
            background-color: var(--btn-bg);
            border-radius: 31px; 
            /* ä½¿ç”¨ bottom å®šä½ç¢ºä¿ä¸æœƒè·‘ç‰ˆ */
            bottom: 20%; left: 50%; transform: translateX(-50%);
            border: none; cursor: pointer; pointer-events: auto;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(200, 151, 117, 0.3);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; animation: fadeUp 1s ease 1s forwards;
        }
        .btn-start-figma:hover { background-color: #b08365; transform: translateX(-50%) scale(1.05); box-shadow: 0 0 30px rgba(200, 151, 117, 0.8); }
        .btn-text { font-family: 'Abhaya Libre', serif; font-size: 60px; color: white; margin: 0; }
        
        .deco-svg { position: absolute; pointer-events: none; mix-blend-mode: screen; opacity: 0.8; }
        .deco-svg path { stroke: white; stroke-width: 2; stroke-linecap: round; fill: none; }
        @keyframes fadeUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* =========================================
           2. ç‰Œé™£é¸æ“‡
           ========================================= */
        #screen-spread { background: radial-gradient(circle at center, #2a103c 0%, #000 100%); }
        #spread-options { display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; z-index: 20; margin-top: 30px;}
        .spread-card {
            width: 200px; height: 280px; border: 1px solid rgba(255,255,255,0.2); border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.3); transition: 0.3s; position: relative; overflow: hidden;
        }
        .spread-card.hovering { border-color: var(--accent-gold); background: rgba(212, 175, 55, 0.1); transform: scale(1.05); }
        .progress-bar { position: absolute; bottom: 0; left: 0; height: 5px; width: 0%; background: var(--accent-gold); }
        .spread-card h3 { font-family: 'Cinzel', serif; color: var(--accent-gold); margin-bottom: 10px; }
        .spread-card p { color: #ccc; font-size: 0.9rem; text-align: center; }

        /* =========================================
           3. æŠ½ç‰Œé  (å‹•ç•«èˆ‡é¸å–ä¿®å¾©)
           ========================================= */
        #screen-draw { background: radial-gradient(circle at 50% 50%, #2c241b 0%, #0f0c09 100%); }
        #carousel-viewport { width: 100%; height: 400px; position: relative; perspective: 1000px; margin-top: 20px; transform-style: preserve-3d; }
        
        .tarot-card {
            position: absolute; width: var(--card-w); height: var(--card-h);
            top: 50%; left: 50%; margin-left: calc(var(--card-w) / -2); margin-top: calc(var(--card-h) / -2);
            border-radius: 12px; transform-style: preserve-3d; transition: box-shadow 0.2s;
        }

        .card-face.back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px;
            background: linear-gradient(135deg, #091c32 0%, #030a14 100%);
            border: 1px solid #3a4b5c; display: flex; justify-content: center; align-items: center;
        }
        .stars-deco { position: absolute; width: 100%; height: 100%; background-image: radial-gradient(white 1px, transparent 1px); background-size: 30px 30px; opacity: 0.3; }
        .moon-deco { width: 50px; height: 50px; border-radius: 50%; box-shadow: inset -8px 0 0 0 var(--accent-cream); transform: rotate(-30deg); opacity: 0.8; }

        .card-face.front {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg);
            border-radius: 12px; background-size: cover; background-position: center; border: 2px solid var(--accent-gold);
        }

        /* é–å®šé€²åº¦åœˆ */
        .lock-ring {
            position: absolute; width: 100px; height: 100px; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-90deg);
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        .lock-circle-bg { stroke: rgba(255,255,255,0.1); stroke-width: 4; fill: none; }
        .lock-circle-fg { stroke: var(--accent-gold); stroke-width: 4; fill: none; stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 0.1s linear; }

        .tarot-card.focused { transform: scale(1.15) translateY(-20px); z-index: 50 !important; box-shadow: 0 0 30px rgba(212, 175, 55, 0.6); }
        .tarot-card.focused .lock-ring { opacity: 1; }
        
        /* [ä¿®å¾©] é£›èµ°å‹•ç•« */
        .tarot-card.picked { animation: flyUp 0.8s forwards ease-in; }
        @keyframes flyUp { 
            0% { transform: translateY(-20px) scale(1.15); opacity: 1; }
            100% { transform: translateY(-600px) scale(0.5); opacity: 0; } 
        }

        /* =========================================
           4. çµæœé  (è³‡æ–™é¡¯ç¤ºä¿®å¾©)
           ========================================= */
        #screen-result { background: #050505; overflow-y: auto; }
        #result-grid { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; max-width: 1000px; padding-bottom: 20px;}
        
        .res-container { display: flex; flex-direction: column; align-items: center; width: 160px; opacity: 0; animation: fadeIn 1s forwards; margin-bottom: 20px; }
        .res-card { width: 140px; height: 240px; border-radius: 8px; background-size: cover; border: 2px solid var(--accent-gold); box-shadow: 0 0 15px rgba(212,175,55,0.3); transition: transform 0.5s; }
        .res-card:hover { transform: scale(1.05); }
        
        .res-desc-box { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            padding: 30px; border-radius: 10px; margin: 0 auto 50px; max-width: 800px; 
            text-align: left; line-height: 1.8; font-size: 1rem; color: #ddd;
            opacity: 0; animation: fadeIn 1s forwards 0.5s;
        }
        .res-desc-box h3 { color: var(--accent-gold); border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 20px; }
        .res-item-text { margin-bottom: 20px; }
        .res-keyword { color: var(--accent-gold); font-size: 0.9rem; margin-left: 10px; }

        @keyframes fadeIn { to { opacity: 1; } }

        /* è¼”åŠ©å…ƒä»¶ */
        #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: var(--accent-gold); font-size: 1.5rem; }
        #video-container { position: fixed; opacity: 0; pointer-events: none; }
        #hand-cursor { position: fixed; width: 12px; height: 12px; background: var(--accent-gold); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 999; display: none; box-shadow: 0 0 10px var(--accent-gold); }
        
        .btn-restart { 
            background: transparent; border: 1px solid var(--accent-gold); color: var(--accent-gold); 
            padding: 10px 40px; border-radius: 30px; margin-bottom: 50px; cursor: pointer; transition: 0.3s; 
        }
        .btn-restart:hover { background: var(--accent-gold); color: black; }
        
        #draw-status { margin-top: 20px; color: #aaa; font-size: 0.9rem; text-align: center; }

    </style>
</head>
<body>

    <!-- 0. é¦–é  -->
    <div id="screen-home" class="screen active">
        <canvas id="life-canvas"></canvas>
        <div class="home-overlay">
            <div class="title-main">ask a question...</div>
            <div class="title-sub">the universe will guide you</div>

            <!-- SVG è£é£¾ (è«‹å¡«å…¥è·¯å¾‘) -->
            <svg class="deco-svg" style="left: 0; top: 0; width: 345px; height: 133px;" viewBox="0 0 345 133"><path d="M1 1.00477C1.2095 1.00477 36.2761 0.953559 91.1817 1.18673C122.796 1.32098 136.94 9.97972 149.26 17.841C167.158 29.2615 172.94 45.3673 177.151 55.5364C180.289 63.1126 180.431 73.8955 179.885 84.2333C179.461 92.2558 174.117 97.3655 169.954 101.124C166.411 104.323 162.239 105.441 157.889 105.978C152.664 106.624 147.883 104.921 145.017 102.214C143.668 100.941 143.726 98.8511 144.144 97.0554C145.005 93.3518 148.286 90.7574 151.467 88.807C157.905 84.8594 183.484 84.91 207.149 90.2618C233.545 96.2312 253.441 113.461 266.438 120.228C294.994 131.181 318.874 133.219 333.207 130.158C336.04 128.791 339.187 126.905 343.671 123.975" /></svg>
            <svg class="deco-svg" style="right: 170px; top: 113px; width: 334px; height: 166px;" viewBox="0 0 334 166"><path d="M1 24.6421C18.3472 24.4871 57.2839 23.027 65.1079 19.6596C69.2739 17.8665 71.5567 13.716 72.9703 10.2003C73.691 8.40784 73.4195 6.27329 72.7958 4.64259C72.1722 3.01189 70.9494 1.86657 69.3959 1.32392C67.8424 0.781262 65.9952 0.875988 64.626 1.94848C61.6186 4.30412 61.5608 9.06797 61.8827 13.2312C62.7275 24.1592 75.1201 35.5874 88.5105 43.2949C101.703 50.8885 130.552 50.7245 161.602 53.0507C194.439 55.5107 208.079 65.0684 215.325 69.973C222.41 74.7687 226.817 84.0054 233.302 108.184C235.793 117.473 233.831 123.291 231.833 126.692C230.048 129.728 225.656 130.299 221.791 130.412C219.932 130.466 218.344 129.293 217.286 127.812C215.043 124.67 215.317 120.197 216.139 116.851C216.526 115.281 218.495 114.622 220.388 114.2C229.788 112.102 248.002 123.559 273.866 147.294C285.771 158.22 299.194 163.021 309.618 164.096C313.542 163.282 317.77 161.175 322.641 158.119C324.95 156.542 326.928 154.913 332.92 150.741" /></svg>
            <svg class="deco-svg" style="right: 190px; bottom: 0; width: 448px; height: 478px;" viewBox="0 0 448 478"><path d="M122.996 471.779C122.725 471.779 111.389 471.473 85.4299 469.301C26.1285 464.34 8.33693 450.575 1.90444 443.695C0.428683 442.116 0.868239 439.72 2.43039 437.173C6.2707 430.912 17.6635 426.081 54.4537 418.413C83.9742 412.26 136.236 405.211 185.098 400.694C233.96 396.177 278.021 395.35 300.816 395.862C326.895 396.447 342.878 402.711 359.936 405.943C371.661 408.165 379.345 413.799 381.8 417.415C384.309 421.113 383.786 428.052 382.896 435.372C382.169 441.355 376.466 443.898 372.083 445.689C369.656 446.682 366.716 447.584 321.202 451.116C275.689 454.648 187.665 460.717 142.762 462.7C97.8589 464.684 98.7435 462.399 106.042 454.094C126.38 430.948 146.212 412.676 156.372 404.768C165.954 397.309 184.573 388.62 203.148 380.117C208.58 377.63 205.741 378.502 179.237 391.077C152.733 403.653 102.608 427.815 74.3306 441.123C46.0533 454.43 41.1423 456.151 37.3019 457.314C33.4614 458.478 30.8402 459.034 29.0954 455.685C24.0511 446.002 28.174 426.489 34.1429 403.789C40.4489 379.807 52.4931 358.06 64.1091 338.495C75.2993 319.647 90.4104 307.095 103.481 298.665C114.529 291.54 128.609 289.899 140.671 290.485C148.929 290.886 148.994 331.077 150.712 379.223C151.464 400.322 153.917 406.152 156.028 410.313C159.783 417.719 167.878 417.606 169.763 423.348C170.974 427.037 171.438 432.655 171.985 413.941C172.532 395.227 172.827 352.102 172.465 326.396C172.103 300.689 171.076 293.708 166.331 278.421C154.222 239.407 144.327 211.848 144.736 195.871C145.047 183.701 146.536 163.319 148.334 152.608C150.133 141.897 152.444 141.484 176.227 141.531C200.01 141.579 245.196 142.099 274.329 142.931C303.461 143.763 315.172 144.89 320.137 149.641C325.103 154.392 322.97 162.731 321.02 190.47C319.07 218.209 317.369 265.094 317.373 296.602C317.38 342.852 321.67 360.999 322.972 367.759C324.513 375.765 324.254 387.215 323.217 401.102C322.692 408.137 320.896 415.022 289.95 421.996C259.005 428.97 198.638 435.793 166.841 438.723C135.044 441.653 133.646 440.483 133.422 423.727C133.199 406.97 134.194 374.661 134.1 354.655C133.901 311.977 118.861 291.135 113.046 286.584C111.636 285.481 109.307 286.715 108.144 285.616C105.2 282.834 106.403 276.974 106.918 272.595C108.192 261.785 138.476 240.584 169.435 208.881C180.24 197.816 190.335 171.156 204.333 136.386C214.731 110.557 216.971 84.0116 220.341 52.2324C222.168 35.0029 227.761 15.9998 230.39 7.16027C233.02 -1.67921 233.419 0.33979 233.681 4.86235C234.344 16.3368 234.849 28.5792 238.154 43.1925C240.341 52.8624 245.331 66.6661 256.719 91.7526C268.107 116.839 286.194 152.677 298.172 174.901C314.497 205.195 325.647 217.726 334.673 227.432C348.301 242.088 360.188 245.926 365.528 247.679C366.479 247.991 360.806 248.995 342.527 249.66C291.694 251.508 255.297 250.916 252.009 250.516C245.335 249.705 270.303 281.346 289.226 324.506C298.894 346.557 311.169 367.781 318.321 381.801C332.352 409.304 331.091 419.197 329.905 425.991C327.54 439.528 268.079 434.249 244.621 427.232C241.09 426.176 242.447 418.69 243.177 415.644C244.341 410.782 270.083 406.394 314.219 395.952C337.175 390.521 360.718 382.623 380.839 378.467C416.384 371.124 434.84 371.249 437.916 368.036C443.604 362.093 445.976 345.778 446.303 333.534C446.654 320.388 409.104 305.48 379.788 295.464C360.264 288.793 337.596 293.338 322.496 297.527C296.503 304.738 289.182 316.659 281.73 327.411C275.076 337.012 276.263 353.047 278.564 367.523C280.814 381.684 298.95 390.222 331.385 400.273C378.532 414.881 413.588 415.234 417.614 417.05C424.677 420.238 428.835 428.53 440.79 463.014C443.317 470.306 442.631 472.344 441.514 473.571C440.397 474.799 438.422 475.294 421.868 475.906C405.314 476.518 374.24 477.232 324.443 474.725C274.645 472.219 207.066 466.47 164.401 464.17C121.735 461.87 106.031 463.194 89.3071 464.755" /></svg>

            <button class="btn-start-figma" onclick="startApp()">
                <p class="btn-text">START</p>
            </button>
        </div>
    </div>

    <!-- 1. ç‰Œé™£ -->
    <div id="screen-spread" class="screen">
        <h2 style="font-family:'Cinzel', serif; color:var(--accent-gold);">è«‹é¸æ“‡ç‰Œé™£</h2>
        <div id="spread-options">
            <div class="spread-card" data-id="single" data-count="1" data-desc="æ¯æ—¥æŒ‡å¼•">
                <h3>å–®å¼µç¥è«­</h3><p>ä¸€é‡è¦‹è¡€çš„æŒ‡å¼•</p><div class="progress-bar"></div>
            </div>
            <div class="spread-card" data-id="time" data-count="3" data-desc="éå» / ç¾åœ¨ / æœªä¾†">
                <h3>æ™‚é–“ä¹‹æµ</h3><p>æ¢ç´¢å› æœç™¼å±•</p><div class="progress-bar"></div>
            </div>
            <div class="spread-card" data-id="body" data-count="3" data-desc="èº« / å¿ƒ / éˆ">
                <h3>èº«å¿ƒéˆ</h3><p>å…¨æ–¹ä½èƒ½é‡æª¢æ¸¬</p><div class="progress-bar"></div>
            </div>
        </div>
        <div id="draw-status">é£ŸæŒ‡åœç•™æ–¼é¸é …ä¸Šå³å¯ç¢ºèª</div>
    </div>

    <!-- 2. æŠ½ç‰Œ -->
    <div id="screen-draw" class="screen">
        <h2 id="draw-prompt" style="font-family:'Cinzel', serif; color:var(--accent-gold);">è«‹é»˜å¿µå•é¡Œ...</h2>
        <p id="draw-counter" style="color:var(--accent-cream); font-size:1.5rem; margin:10px 0;">0 / 3</p>
        <div id="carousel-viewport"></div>
        <div id="draw-status">å·¦å³æ»‘å‹•ç€è¦½ ï½œ åœç•™ <span style="color:white; font-weight:bold;">2ç§’</span> ç­‰å¾…é‡‘åœˆè·‘æ»¿é¸å®š</div>
    </div>

    <!-- 3. çµæœ -->
    <div id="screen-result" class="screen">
        <h2 style="font-family:'Cinzel', serif; color:var(--accent-gold); margin-top:50px;">å‘½é‹æŒ‡å¼•</h2>
        <div id="result-grid"></div>
        <div id="interpretation-area" class="res-desc-box"></div>
        <button id="restart-btn" class="btn-restart" onclick="window.location.reload()">é‡æ–°å åœ</button>
    </div>

    <div id="loading-overlay"><div>é€£çµå®‡å®™èƒ½é‡ä¸­...</div></div>
    <div id="video-container"><video id="input_video" playsinline></video></div>
    <div id="hand-cursor"></div>

    <script>
        // --- Game of Life Background ---
        const lifeCanvas = document.getElementById('life-canvas');
        const lifeCtx = lifeCanvas.getContext('2d');
        let lifeGrid = [];
        let lifeCols, lifeRows;
        const cellSize = 12;
        let lifeRunning = true;

        function initLife() {
            resizeLife();
            window.addEventListener('resize', resizeLife);
            lifeCanvas.addEventListener('click', (e) => {
                const rect = lifeCanvas.getBoundingClientRect();
                spawnPattern(Math.floor((e.clientY-rect.top)/cellSize), Math.floor((e.clientX-rect.left)/cellSize));
            });
            requestAnimationFrame(lifeLoop);
        }
        function resizeLife() {
            lifeCanvas.width = window.innerWidth; lifeCanvas.height = window.innerHeight;
            lifeCols = Math.ceil(lifeCanvas.width / cellSize); lifeRows = Math.ceil(lifeCanvas.height / cellSize);
            lifeGrid = Array(lifeRows).fill(0).map(() => Array(lifeCols).fill(null));
        }
        function spawnPattern(r, c) {
            const colors = ["#008080", "#fe9d72", "#c89775", "#ffffff", "#ffd700"];
            const color = colors[Math.floor(Math.random() * colors.length)];
            [[0,0], [1,0], [-1,0], [0,1], [0,-1]].forEach(([dy, dx]) => {
                const nr = (r + dy + lifeRows) % lifeRows;
                const nc = (c + dx + lifeCols) % lifeCols;
                lifeGrid[nr][nc] = { alive: true, color: color };
            });
        }
        function updateLife() {
            const newGrid = lifeGrid.map(row => [...row]);
            for (let r = 0; r < lifeRows; r++) {
                for (let c = 0; c < lifeCols; c++) {
                    let neighbors = 0;
                    for (let i = -1; i <= 1; i++) {
                        for (let j = -1; j <= 1; j++) {
                            if (i === 0 && j === 0) continue;
                            const nr = (r + i + lifeRows) % lifeRows;
                            const nc = (c + j + lifeCols) % lifeCols;
                            if (lifeGrid[nr][nc] && lifeGrid[nr][nc].alive) neighbors++;
                        }
                    }
                    const cell = lifeGrid[r][c];
                    const alive = cell && cell.alive;
                    if (alive && (neighbors < 2 || neighbors > 3)) newGrid[r][c] = null;
                    else if (!alive && neighbors === 3) {
                        newGrid[r][c] = { alive: true, color: ["#008080", "#fe9d72"][Math.floor(Math.random()*2)] };
                    }
                }
            }
            lifeGrid = newGrid;
        }
        let lastTime = 0;
        function lifeLoop(timestamp) {
            if (!lifeRunning) return;
            if (timestamp - lastTime > 80) {
                updateLife();
                lifeCtx.fillStyle = 'black'; lifeCtx.fillRect(0, 0, lifeCanvas.width, lifeCanvas.height);
                for (let r = 0; r < lifeRows; r++) {
                    for (let c = 0; c < lifeCols; c++) {
                        if (lifeGrid[r][c] && lifeGrid[r][c].alive) {
                            lifeCtx.fillStyle = lifeGrid[r][c].color;
                            lifeCtx.fillRect(c * cellSize, r * cellSize, cellSize - 1, cellSize - 1);
                        }
                    }
                }
                lastTime = timestamp;
            }
            requestAnimationFrame(lifeLoop);
        }
        initLife();

        // --- Tarot Logic ---
        const majorArcana = [
            { name: "æ„šè€…", url: "9/90/RWS_Tarot_00_Fool.jpg", rev: "å†’éšª/å¤©çœŸ", meaning: "ä»£è¡¨ä¸€å€‹æ–°çš„é–‹å§‹ï¼Œä½ å¯èƒ½å³å°‡è¸ä¸Šä¸€æ®µæœªçŸ¥çš„æ—…ç¨‹ã€‚è«‹ä¿æŒé–‹æ”¾çš„å¿ƒæ…‹ï¼Œä½†ä¹Ÿè¦æ³¨æ„è…³ä¸‹çš„è·¯ã€‚" },
            { name: "é­”è¡“å¸«", url: "d/de/RWS_Tarot_01_Magician.jpg", rev: "å‰µé€ /åŠ›é‡", meaning: "ä½ æ“æœ‰å¯¦ç¾ç›®æ¨™æ‰€éœ€çš„æ‰€æœ‰è³‡æºèˆ‡èƒ½åŠ›ã€‚ç¾åœ¨æ˜¯æ¡å–è¡Œå‹•ã€å°‡æƒ³æ³•è½‰åŒ–ç‚ºç¾å¯¦çš„æœ€ä½³æ™‚æ©Ÿã€‚" },
            { name: "å¥³ç¥­å¸", url: "8/88/RWS_Tarot_02_High_Priestess.jpg", rev: "ç›´è¦º/æ½›æ„è­˜", meaning: "è«‹å‚¾è½ä½ å…§åœ¨çš„è²éŸ³èˆ‡ç›´è¦ºã€‚æœ‰äº›ç­”æ¡ˆç„¡æ³•å‘å¤–å°‹æ±‚ï¼Œåªèƒ½åœ¨éœé»˜ä¸­ç²å¾—ã€‚" },
            { name: "çš‡å", url: "d/d2/RWS_Tarot_03_Empress.jpg", rev: "è±ç››/è‡ªç„¶", meaning: "é€™æ˜¯ä¸€å€‹å­•è‚²èˆ‡è±æ”¶çš„æ™‚åˆ»ã€‚ç„¡è«–æ˜¯è¨ˆç•«é‚„æ˜¯ç”Ÿæ´»ï¼Œéƒ½å°‡è¿ä¾†å……æ»¿æ„›èˆ‡ç¾çš„æˆæœã€‚" },
            { name: "çš‡å¸", url: "c/c3/RWS_Tarot_04_Emperor.jpg", rev: "æ¬Šå¨/çµæ§‹", meaning: "ä½ éœ€è¦å»ºç«‹ç§©åºèˆ‡ç´€å¾‹ã€‚ç©©å›ºçš„åŸºç¤èˆ‡ç†æ€§çš„è¦åŠƒå°‡å¹«åŠ©ä½ æŒæ§å±€å‹¢ã€‚" },
            { name: "æ•™çš‡", url: "8/8d/RWS_Tarot_05_Hierophant.jpg", rev: "å‚³çµ±/æŒ‡å¼•", meaning: "å°‹æ±‚é•·è¼©æˆ–å°ˆæ¥­äººå£«çš„å»ºè­°æœƒå°ä½ æœ‰æ‰€å¹«åŠ©ã€‚éµå¾ªå‚³çµ±æˆ–æ—¢å®šçš„é«”åˆ¶å¯èƒ½æ›´ç‚ºå®‰å…¨ã€‚" },
            { name: "æˆ€äºº", url: "d/db/RWS_Tarot_06_Lovers.jpg", rev: "æ„›/é¸æ“‡", meaning: "é¢è‡¨é‡è¦çš„é¸æ“‡ï¼Œé€™å¯èƒ½é—œä¹æ„Ÿæƒ…æˆ–åƒ¹å€¼è§€ã€‚è«‹éµå¾ä½ çš„å¿ƒï¼Œå°‹æ±‚å’Œè«§çš„çµåˆã€‚" },
            { name: "æˆ°è»Š", url: "9/9b/RWS_Tarot_07_Chariot.jpg", rev: "å‹åˆ©/æ„å¿—", meaning: "é€™æ˜¯å…‹æœå›°é›£çš„æ™‚åˆ»ã€‚åªè¦ä½ æœ‰å …å®šçš„æ„å¿—èˆ‡è‡ªæ§åŠ›ï¼Œä»»ä½•æŒ‘æˆ°éƒ½èƒ½è¢«çªç ´ã€‚" },
            { name: "åŠ›é‡", url: "f/f5/RWS_Tarot_08_Strength.jpg", rev: "å‹‡æ°£/è€å¿ƒ", meaning: "çœŸæ­£çš„åŠ›é‡ä¾†è‡ªæ–¼å…§å¿ƒçš„æº«æŸ”èˆ‡å …éŸŒã€‚ä»¥æŸ”å…‹å‰›ï¼Œè€å¿ƒå°‡æ˜¯ä½ æœ€å¤§çš„æ­¦å™¨ã€‚" },
            { name: "éš±è€…", url: "4/4d/RWS_Tarot_09_Hermit.jpg", rev: "åçœ/å­¤ç¨", meaning: "æš«æ™‚é€€å¾Œä¸€æ­¥ï¼Œçµ¦è‡ªå·±ç¨è™•çš„ç©ºé–“ã€‚ä½ éœ€è¦å‘å…§æ¢ç´¢ï¼Œå°‹æ‰¾å…§å¿ƒçš„çœŸç†ã€‚" },
            { name: "å‘½é‹ä¹‹è¼ª", url: "3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg", rev: "æ”¹è®Š/æ©Ÿé‡", meaning: "ç”Ÿå‘½æ­£è™•æ–¼è½‰æŠ˜é»ã€‚é †æ‡‰å‘½é‹çš„æµå‹•ï¼ŒæŠŠæ¡çªå¦‚å…¶ä¾†çš„æ©Ÿé‡ã€‚" },
            { name: "æ­£ç¾©", url: "e/e0/RWS_Tarot_11_Justice.jpg", rev: "å…¬å¹³/çœŸç›¸", meaning: "å› æœå¾ªç’°ï¼Œç¨®ç“œå¾—ç“œã€‚ä¿æŒèª å¯¦èˆ‡å…¬æ­£ï¼Œä½ å°‡å¾—åˆ°æ‡‰æœ‰çš„çµæœã€‚" },
            { name: "å€’åŠäºº", url: "2/2b/RWS_Tarot_12_Hanged_Man.jpg", rev: "çŠ§ç‰²/è§€é»", meaning: "äº‹æƒ…å¯èƒ½æš«æ™‚åœæ»¯ã€‚è©¦è‘—æ›å€‹è§’åº¦çœ‹ä¸–ç•Œï¼Œæˆ–è¨±éœ€è¦ä¸€äº›çŠ§ç‰²æ‰èƒ½æ›ä¾†æ–°çš„è¦–è§’ã€‚" },
            { name: "æ­»ç¥", url: "d/d7/RWS_Tarot_13_Death.jpg", rev: "çµæŸ/é‡ç”Ÿ", meaning: "ä¸è¦å®³æ€•çµæŸï¼Œé€™æ˜¯è½‰è®Šçš„å¿…ç¶“éç¨‹ã€‚å‘Šåˆ¥èˆŠçš„æ¨¡å¼ï¼Œæ‰èƒ½è¿æ¥æ–°çš„ç”Ÿå‘½ã€‚" },
            { name: "ç¯€åˆ¶", url: "f/f8/RWS_Tarot_14_Temperance.jpg", rev: "å¹³è¡¡/å”èª¿", meaning: "å°‹æ±‚ä¸­åº¸ä¹‹é“ã€‚é€éè€å¿ƒèˆ‡é©åº¦çš„èª¿å’Œï¼Œä½ å°‡æ‰¾åˆ°ç”Ÿæ´»ä¸­çš„å¹³è¡¡é»ã€‚" },
            { name: "æƒ¡é­”", url: "5/55/RWS_Tarot_15_Devil.jpg", rev: "æŸç¸›/èª˜æƒ‘", meaning: "è­¦æƒ•éåº¦çš„æ…¾æœ›æˆ–åŸ·è‘—ã€‚ä½ å¯èƒ½æ„Ÿåˆ°è¢«æŸç¸›ï¼Œä½†é‘°åŒ™å…¶å¯¦å°±åœ¨ä½ æ‰‹ä¸­ã€‚" },
            { name: "é«˜å¡”", url: "5/53/RWS_Tarot_16_Tower.jpg", rev: "çªè®Š/å•Ÿç¤º", meaning: "çªå¦‚å…¶ä¾†çš„æ”¹è®Šå¯èƒ½æœƒç ´å£ç¾ç‹€ï¼Œä½†é€™ä¹Ÿæ˜¯é‡å»ºæ›´çœŸå¯¦è‡ªæˆ‘çš„å¥‘æ©Ÿã€‚" },
            { name: "æ˜Ÿæ˜Ÿ", url: "d/db/RWS_Tarot_17_Star.jpg", rev: "å¸Œæœ›/éˆæ„Ÿ", meaning: "é¢¨æš´éå¾Œçš„å¯§éœã€‚ä¿æŒå¸Œæœ›èˆ‡ä¿¡å¿ƒï¼Œå®‡å®™æ­£åœ¨æŒ‡å¼•ä½ æ­£ç¢ºçš„æ–¹å‘ã€‚" },
            { name: "æœˆäº®", url: "7/7f/RWS_Tarot_18_Moon.jpg", rev: "ä¸å®‰/å¹»è¦º", meaning: "äº‹æƒ…å¯èƒ½ä¸åƒè¡¨é¢çœ‹èµ·ä¾†é‚£æ¨£ã€‚é¢å°æ½›æ„è­˜çš„ææ‡¼ï¼Œå°å¿ƒå¹»è¦ºèˆ‡èª¤å°ã€‚" },
            { name: "å¤ªé™½", url: "1/17/RWS_Tarot_19_Sun.jpg", rev: "å¿«æ¨‚/æˆåŠŸ", meaning: "å……æ»¿æ´»åŠ›èˆ‡å–œæ‚…çš„æ™‚åˆ»ã€‚é™°éœ¾æ•£å»ï¼ŒæˆåŠŸèˆ‡å¹¸é‹å°‡èˆ‡ä½ åŒåœ¨ã€‚" },
            { name: "å¯©åˆ¤", url: "d/dd/RWS_Tarot_20_Judgement.jpg", rev: "è¦ºé†’/å¬å–š", meaning: "é€™æ˜¯ä¸€å€‹è¦ºé†’çš„æ™‚åˆ»ã€‚å›é¡§éå»ï¼ŒåŸè«’è‡ªå·±ï¼ŒéŸ¿æ‡‰å…§å¿ƒçš„å¬å–šã€‚" },
            { name: "ä¸–ç•Œ", url: "f/ff/RWS_Tarot_21_World.jpg", rev: "åœ“æ»¿/å®Œæˆ", meaning: "ä¸€å€‹éšæ®µçš„å®Œç¾çµæŸã€‚ä½ å·²ç¶“å®Œæˆäº†ç›®æ¨™ï¼Œæº–å‚™å¥½è¿æ¥ä¸‹ä¸€å€‹å±¤æ¬¡ã€‚" }
        ];

        let gameState = 'HOME';
        let currentSpread = null;
        let cardElements = [];
        let selectedCards = [];
        let scrollPos = 0, targetScrollPos = 0;
        let handPos = { x: 0.5, y: 0.5 };
        let isHandPresent = false;
        
        let currentHoverIdx = -1;
        let hoverStartTime = 0;
        const HOVER_THRESHOLD = 2000;
        let isSelectionLocked = false;
        const CARD_SPACING = 180;
        
        const viewport = document.getElementById('carousel-viewport');
        const cursor = document.getElementById('hand-cursor');

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function initSpreadSelection() {
            gameState = 'SPREAD';
            switchScreen('screen-spread');
        }

        function checkSpreadHover() {
            if (gameState !== 'SPREAD' || !isHandPresent) return;
            const el = document.elementFromPoint(handPos.x * window.innerWidth, handPos.y * window.innerHeight);
            const card = el ? el.closest('.spread-card') : null;
            document.querySelectorAll('.spread-card').forEach(c => {
                if(c === card) {
                    if(!c.classList.contains('hovering')) {
                        c.classList.add('hovering');
                        c.querySelector('.progress-bar').style.transition = 'width 2s linear';
                        c.querySelector('.progress-bar').style.width = '100%';
                        c.hoverTimer = setTimeout(() => selectSpread(c.dataset), 2000);
                    }
                } else {
                    c.classList.remove('hovering');
                    c.querySelector('.progress-bar').style.transition = 'none';
                    c.querySelector('.progress-bar').style.width = '0%';
                    clearTimeout(c.hoverTimer);
                }
            });
        }

        function selectSpread(data) {
            currentSpread = { id: data.id, count: parseInt(data.count), desc: data.desc };
            initDraw();
        }

        function initDraw() {
            gameState = 'DRAW';
            selectedCards = [];
            isSelectionLocked = false;
            switchScreen('screen-draw');
            document.getElementById('draw-prompt').innerText = "è«‹é»˜å¿µå•é¡Œ...";
            updateCounter();
            viewport.innerHTML = '';
            cardElements = [];
            let deck = [...majorArcana].sort(() => Math.random() - 0.5);
            deck.forEach((data, i) => {
                const el = document.createElement('div'); el.className = 'tarot-card';
                el.innerHTML = `
                    <div class="card-face back">
                        <div class="stars-deco"></div><div class="moon-deco"></div>
                        <svg class="lock-ring" viewBox="0 0 100 100">
                            <circle class="lock-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle class="lock-circle-fg" cx="50" cy="50" r="45"></circle>
                        </svg>
                    </div>
                    <div class="card-face front" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/${data.url}')"></div>`;
                viewport.appendChild(el);
                cardElements.push({ el, data, baseX: i * CARD_SPACING, picked: false });
            });
            scrollPos = (cardElements.length * CARD_SPACING) / 2; targetScrollPos = scrollPos;
        }

        function updateCounter() {
            document.getElementById('draw-counter').innerText = `${selectedCards.length} / ${currentSpread.count}`;
        }

        function renderCarousel() {
            if (gameState !== 'DRAW') return;
            let speed = 0;
            if (isHandPresent && !isSelectionLocked) {
                if (handPos.x < 0.2) speed = (0.2 - handPos.x) * 50; // Speed up
                else if (handPos.x > 0.8) speed = -(handPos.x - 0.8) * 50;
            }
            targetScrollPos += speed;
            targetScrollPos = Math.max(0, Math.min(targetScrollPos, (cardElements.length-1)*CARD_SPACING));
            scrollPos += (targetScrollPos - scrollPos) * 0.1;

            // [ä¿®å¾©] è¨ˆç®—ä¸­å¿ƒèˆ‡å–®ä¸€é–å®š
            let centerIdx = -1, minDist = 9999;
            cardElements.forEach((c, i) => {
                if (c.picked) return;
                let dist = c.baseX - scrollPos;
                if (Math.abs(dist) < minDist) { minDist = Math.abs(dist); centerIdx = i; }
            });

            // æ¸²æŸ“èˆ‡äº’å‹•
            cardElements.forEach((c, i) => {
                if (c.picked) return;
                let dist = c.baseX - scrollPos;
                let norm = Math.max(-1, Math.min(1, dist / 600));
                let scale = 1 - Math.abs(norm) * 0.3;
                let rotY = -norm * 45;

                // åªæœ‰æœ€ä¸­é–“é‚£å¼µï¼Œä¸”ç¬¦åˆæ¢ä»¶ï¼Œæ‰å…è¨± Hover
                const isHovering = (i === centerIdx && isHandPresent && Math.abs(speed) < 2 && !isSelectionLocked && selectedCards.length < currentSpread.count);
                const ring = c.el.querySelector('.lock-circle-fg');
                
                if (isHovering) {
                    if (currentHoverIdx !== i) { currentHoverIdx = i; hoverStartTime = Date.now(); }
                    const elapsed = Date.now() - hoverStartTime;
                    const progress = Math.min(elapsed / HOVER_THRESHOLD, 1);
                    ring.style.strokeDashoffset = 283 - (283 * progress);
                    c.el.classList.add('focused');
                    if (progress >= 1) pickCard(i);
                } else {
                    if (currentHoverIdx === i) currentHoverIdx = -1;
                    ring.style.strokeDashoffset = 283;
                    c.el.classList.remove('focused');
                }

                c.el.style.transform = `translateX(${dist}px) translateZ(${-Math.abs(dist)*0.5}px) rotateY(${rotY}deg) scale(${scale})`;
                c.el.style.zIndex = 100 - Math.round(Math.abs(norm)*100);
                c.el.style.opacity = 1 - Math.abs(norm)*0.5;
            });
        }

        function pickCard(idx) {
            if (isSelectionLocked) return;
            isSelectionLocked = true; // å¼·åˆ¶é–å®š
            
            const c = cardElements[idx];
            c.picked = true; 
            c.el.classList.add('picked'); // æ’­æ”¾é£›èµ°å‹•ç•«
            
            const isReversed = Math.random() < 0.5;
            selectedCards.push({ data: c.data, reversed: isReversed });
            updateCounter();

            if (selectedCards.length >= currentSpread.count) {
                document.getElementById('draw-prompt').innerText = "æŠ½å–å®Œæˆï¼Œæ­£åœ¨è§£è®€...";
                setTimeout(showResults, 1500);
            } else {
                // å†·å» 2 ç§’ï¼Œé˜²æ­¢èª¤è§¸ä¸‹ä¸€å¼µ
                setTimeout(() => { 
                    isSelectionLocked = false; 
                    currentHoverIdx = -1; 
                }, 2000);
            }
        }

        function showResults() {
            gameState = 'RESULT';
            switchScreen('screen-result');
            const grid = document.getElementById('result-grid'); grid.innerHTML = '';
            const descBox = document.getElementById('interpretation-area');
            const positionNames = currentSpread.id === 'time' ? ['éå»', 'ç¾åœ¨', 'æœªä¾†'] :
                                  currentSpread.id === 'body' ? ['èº« (Body)', 'å¿ƒ (Mind)', 'éˆ (Spirit)'] : ['æŒ‡å¼•'];
            let htmlDesc = `<h3>ğŸ”® ç¶œåˆè§£è®€</h3>`;
            
            selectedCards.forEach((item, i) => {
                const pos = positionNames[i] || `ç¬¬ ${i+1} å¼µ`;
                const status = item.reversed ? "é€†ä½" : "æ­£ä½";
                const transform = item.reversed ? 'transform: rotate(180deg)' : '';
                
                grid.insertAdjacentHTML('beforeend', `
                    <div class="res-container" style="animation-delay: ${i*0.3}s">
                        <div style="color:var(--accent-cream); margin-bottom:5px;">${pos}</div>
                        <div class="res-card" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/${item.data.url}'); ${transform}"></div>
                        <div style="margin-top:5px; font-weight:bold;">${item.data.name}</div>
                        <div style="font-size:0.8rem; color:#aaa;">${status}</div>
                    </div>
                `);
                htmlDesc += `<div class="res-item-text">
                    <p style="color:var(--accent-cream); font-weight:bold;">ã€${pos} - ${item.data.name} (${status})ã€‘</p>
                    <p>${item.data.meaning}</p>
                    <p class="res-keyword">é—œéµå­—: ${item.data.rev}</p>
                </div>`;
            });
            descBox.innerHTML = htmlDesc;
        }

        async function startApp() {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.6 });
                hands.onResults(onHandResults);

                const video = document.getElementById('input_video');
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('screen-home').classList.remove('active');
                    lifeRunning = false; 
                    initSpreadSelection();
                    const predict = async () => { if(video.videoWidth) await hands.send({image: video}); requestAnimationFrame(predict); };
                    predict();
                    const animate = () => {
                        if(gameState === 'SPREAD') checkSpreadHover();
                        if(gameState === 'DRAW') renderCarousel();
                        requestAnimationFrame(animate);
                    };
                    animate();
                };
            } catch (e) { alert("å•Ÿå‹•å¤±æ•—: " + e.message); document.getElementById('loading-overlay').style.display = 'none'; }
        }

        function onHandResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                isHandPresent = true;
                const tip = results.multiHandLandmarks[0][8];
                handPos.x = 1 - tip.x; handPos.y = tip.y;
                cursor.style.left = (handPos.x * window.innerWidth) + 'px';
                cursor.style.top = (handPos.y * window.innerHeight) + 'px';
                cursor.style.display = 'block';
                
                if(gameState === 'RESULT') {
                    const btn = document.getElementById('restart-btn');
                    const r = btn.getBoundingClientRect();
                    const hx = handPos.x * window.innerWidth, hy = handPos.y * window.innerHeight;
                    if(hx>r.left && hx<r.right && hy>r.top && hy<r.bottom) {
                        if(!btn.hoverStart) btn.hoverStart = Date.now();
                        btn.style.background="var(--accent-gold)"; btn.style.color="black";
                        if(Date.now()-btn.hoverStart > 1000) window.location.reload();
                    } else {
                        btn.hoverStart = null; btn.style.background="transparent"; btn.style.color="var(--accent-gold)";
                    }
                }
            } else { isHandPresent = false; cursor.style.display = 'none'; }
        }

        document.querySelector('.btn-start-figma').addEventListener('click', startApp);
        document.getElementById('restart-btn').addEventListener('click', () => window.location.reload());

    </script>
</body>
</html>